(function(e){var t=acf.media;acf.fields.gallery={$el:null,o:{},set:function(t){e.extend(this,t);this.$input=this.$el.children('input[type="hidden"]');this.o=acf.helpers.get_atts(this.$el);this.o.query={};this.o.library=="uploadedTo"&&(this.o.query.uploadedTo=acf.o.post_id);this.o.view="grid";this.$el.hasClass("view-list")&&(this.o.view="list");return this},init:function(){if(acf.helpers.is_clone_field(this.$input))return;this.render();this.$el.find("> .thumbnails > .inner").sortable({items:"> .thumbnail",forceHelperSize:!0,forcePlaceholderSize:!0,scroll:!0,start:function(e,t){t.placeholder.width(t.placeholder.width()-4);t.placeholder.height(t.placeholder.height()-4)}})},view:function(e){this.o.view=e;this.render()},render:function(){var e=this.$el.find(".thumbnails .thumbnail").length,t=acf.l10n.gallery["count_"+Math.min(e,2)].replace("%d",e),n=this.$el.find(".toolbar .count");n.html(t);if(this.o.view=="list"){this.$el.addClass("view-list");this.$el.find(".toolbar .view-grid-li").removeClass("active");this.$el.find(".toolbar .view-list-li").addClass("active")}else{this.$el.removeClass("view-list");this.$el.find(".toolbar .view-grid-li").addClass("active");this.$el.find(".toolbar .view-list-li").removeClass("active")}},add:function(n){this.set({$el:t.div});var r=this.$el.find(".tmpl-thumbnail").html();e.each(n,function(e,t){var n=new RegExp("{"+e+"}","g");r=r.replace(n,t)});this.$el.find(".thumbnails > .inner").append(r);this.render();this.$el.closest(".field").removeClass("error")},edit:function(n){t.div=this.$el;t.clear_frame();t.frame=wp.media({title:acf.l10n.gallery.edit,multiple:!1,button:{text:acf.l10n.gallery.update}});t.frame.on("open",function(){t.frame.$el.closest(".media-modal").addClass("acf-media-modal acf-expanded");var r=t.frame.state().get("selection"),i=wp.media.attachment(n);i.fetch();r.add(i);t.frame.$el.on("change",".setting input, .setting textarea",function(){var t=e(this),r=t.closest(".setting").attr("data-setting");e('.acf-gallery .thumbnail[data-id="'+n+'"] .td-'+r).html(t.val())})});t.frame.on("close",function(){t.frame.$el.closest(".media-modal").removeClass("acf-media-modal")});t.frame.open()},remove:function(e){var t=this;$thumb=this.$el.find('.thumbnails .thumbnail[data-id="'+e+'"]');$thumb.animate({opacity:0},250,function(){$thumb.remove();t.render()})},render_collection:function(){setTimeout(function(){var e=t.div,n=t.frame.content.get().$el;collection=t.frame.content.get().collection||null;if(collection){var r=-1;collection.each(function(t){r++;var s=n.find(".attachments > .attachment:eq("+r+")");if(e.find('.thumbnails .thumbnail[data-id="'+t.id+'"]').exists()){t.off("selection:single");s.addClass("acf-selected")}})}},0)},popup:function(){var n=this;t.div=this.$el;t.clear_frame();t.frame=wp.media({states:[new wp.media.controller.Library({library:wp.media.query(this.o.query),multiple:!0,title:acf.l10n.gallery.select,priority:20,filterable:"all"})]});t.frame.on("content:activate",function(){var r=null,i=null;try{r=t.frame.content.get().toolbar;i=r.get("filters")}catch(s){}if(!i)return!1;if(n.o.library=="uploadedTo"){i.$el.find('option[value="uploaded"]').remove();i.$el.after("<span>"+acf.l10n.gallery.uploadedTo+"</span>");e.each(i.filters,function(e,t){t.props.uploadedTo=acf.o.post_id})}n.render_collection();t.frame.content.get().collection.on("reset add",function(){n.render_collection()})});t.frame.on("select",function(){selection=t.frame.state().get("selection");selection&&selection.each(function(e){if(n.$el.find('.thumbnails .thumbnail[data-id="'+e.id+'"]').exists())return;var t={id:e.id,title:e.attributes.title,name:e.attributes.filename,url:e.attributes.url,caption:e.attributes.caption,alt:e.attributes.alt,description:e.attributes.description};e.attributes.type!="image"&&(t.url=e.attributes.icon);e.attributes.sizes&&e.attributes.sizes[n.o.preview_size]&&(t.url=e.attributes.sizes[n.o.preview_size].url);n.add(t)})});t.frame.open();return!1}};e(document).on("click",".acf-gallery .acf-button-edit",function(t){t.preventDefault();var n=e(this).closest(".thumbnail").attr("data-id");acf.fields.gallery.set({$el:e(this).closest(".acf-gallery")}).edit(n);e(this).blur()});e(document).on("click",".acf-gallery .acf-button-delete",function(t){t.preventDefault();var n=e(this).closest(".thumbnail").attr("data-id");acf.fields.gallery.set({$el:e(this).closest(".acf-gallery")}).remove(n);e(this).blur()});e(document).on("click",".acf-gallery .add-image",function(t){t.preventDefault();acf.fields.gallery.set({$el:e(this).closest(".acf-gallery")}).popup();e(this).blur()});e(document).on("click",".acf-gallery .view-grid",function(t){t.preventDefault();acf.fields.gallery.set({$el:e(this).closest(".acf-gallery")}).view("grid");e(this).blur()});e(document).on("click",".acf-gallery .view-list",function(t){t.preventDefault();acf.fields.gallery.set({$el:e(this).closest(".acf-gallery")}).view("list");e(this).blur()});e(document).on("acf/setup_fields",function(t,n){e(n).find(".acf-gallery").each(function(){acf.fields.gallery.set({$el:e(this)}).init()})})})(jQuery);